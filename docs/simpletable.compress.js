var cgrid={grids:{},instance:function(tableid,options){var gridobj={};var getVal=function(key,_default){if(options[key]instanceof Function){return options[key]}if(options[key]){return options[key]}return _default};gridobj.option={withCheckBox:getVal('withCheckBox',false),disableMutiSel:getVal('disableMutiSel',false),hasPage:getVal('hasPage',false),rowNum:getVal('rowNum',false),head:getVal('head',[]),tableClass:getVal('tableClass',''),titleFixed:getVal('titleFixed',false),mergecolcellsize:getVal('mergecolcellsize',10),mergeinrows:getVal('mergeinrows',[]),mergerowcellsize:getVal('mergerowcellsize',2),numfixed:getVal('numfixed',-1),colTitle:getVal('colTitle',false),onRowClick:getVal('onRowClick',function(rownum){}),onRowDbClick:getVal('onRowDbClick',function(rownum){}),finished:getVal('finished',function(){}),onLinkClick:getVal('onLinkClick',function(rownum,colname,e){})};gridobj.data=[];gridobj.allPageData=[];gridobj.headObj={'data-field':'','name':'','display':true,'mergeRow':false,'fixed':false,'children':[]};gridobj.mergeincols=[];gridobj.titles=[];gridobj.titles_zh=[];gridobj.fixedCols=[];gridobj.fixedHeads=[];gridobj.genTable=function(rows){this.data=rows;var colNames=[];var hideCols=[];var aCols=[];var tableStr="<table style='overflow: hidden;'";if(this.option.tableClass){tableStr+=" class='"+this.option.tableClass+"'"}tableStr+=">";var headnum=[0];var headMap={};var headSpan={};var headChildMap={};var relHeads=[];var loopHead=function(iterObj,num){if(iterObj.hasOwnProperty('children')&&iterObj.children.length>0){for(var i in iterObj['children']){var childObj=iterObj['children'][i];headSpan[childObj['data-field']]=childObj;if(headChildMap.hasOwnProperty(iterObj['data-field'])){headChildMap[iterObj['data-field']].push(childObj['data-field'])}else{headChildMap[iterObj['data-field']]=[childObj['data-field']]}if(headMap.hasOwnProperty(num+1)){headMap[num+1].push(childObj['data-field'])}else{headMap[num+1]=[childObj['data-field']]}if(headnum.indexOf(num+1)<0){headnum.push(num+1)}loopHead(childObj,num+1)}}else{relHeads.push(iterObj)}};for(var i in gridobj.option.head){var head=gridobj.option.head[i];headSpan[head['data-field']]=head;if(headMap.hasOwnProperty(0)){headMap[0].push(head['data-field'])}else{headMap[0]=[head['data-field']]}loopHead(head,0)}var rownum=headnum[headnum.length-1];for(var i in headnum){var head=headMap[i];for(var j in head){var it=head[j];if(headChildMap.hasOwnProperty(it)){var childnums=0;var hidenum=0;for(var iter in headChildMap[it]){var iterObj=headChildMap[it][iter];var loopHide=function(iterKey){if(headSpan[iterKey].hasOwnProperty('display')&&!headSpan[iterKey]['display']){++hidenum}var childs=headChildMap[iterKey];if(childs&&childs.length>0){childnums+=childs.length;for(var citer in childs){loopHide(childs[citer])}}else{++childnums}};loopHide(iterObj)}headSpan[it].colspan=childnums-hidenum;headSpan[it].rowspan=1}else{headSpan[it].colspan=1;headSpan[it].rowspan=rownum-i+1}}}for(var i in relHeads){var item=relHeads[i];for(var k in gridobj.headObj){if(!item.hasOwnProperty(k)){item[k]=gridobj.headObj[k]}}colNames.push(item['data-field']);if(!item['display']){hideCols.push(item['data-field'])}else{this.titles.push(item['data-field']);this.titles_zh.push(item['name'])}if(item['link']){aCols.push(item['data-field'])}if(item['mergeRow']){var colIdxStart=1;if(this.option.withCheckBox){++colIdxStart}this.mergeincols.push(parseInt(i)+colIdxStart)}if(item['fixed']){var colIdxStart=1;if(this.option.withCheckBox){if(this.fixedCols.indexOf(1)<0){this.fixedCols.push(1)}++colIdxStart}this.fixedCols.push(parseInt(i)+colIdxStart)}}for(var i in headSpan){var iter=headSpan[i];if(iter.hasOwnProperty('fixed')&&iter['fixed']){this.fixedHeads.push(iter['data-field'])}}var headStr="<thead>";for(var i in headnum){headStr+="<tr>";if(this.option.withCheckBox&&i==="0"){if(this.option.disableMutiSel){headStr+="<th colspan='1' rowspan='"+rownum+"'></th>"}else{headStr+="<th colspan='1' rowspan='"+rownum+"'><input type='checkbox' onchange='cgrid.grids[\""+tableid+"\"].ckBox()'/></th>"}}var head=headMap[i];for(var j in head){var it=head[j];var iter=headSpan[it];headStr+="<th ";if((iter.hasOwnProperty('display')&&!iter['display'])||(iter.hasOwnProperty('colspan')&&iter['colspan']<=0)){headStr+=" style='display:none;' "}headStr+=" colspan='"+iter.colspan+"' rowspan='"+iter.rowspan+"' data-field='"+iter['data-field']+"'>"+iter['name']+"</th>"}headStr+="</tr>"}headStr+="</thead>";var rowsStr="<tbody>";for(var i=0;i<rows.length;++i){if(this.option.hasPage&&i>=this.option.rowNum){break}var row=rows[i];var rowStr="<tr ondblclick='cgrid.grids[\""+tableid+"\"].doubleClickRow("+i+")' data-index='"+i+"' onClick='cgrid.grids[\""+tableid+"\"].oneClickRow("+i+")' data-index='"+i+"'>";if(this.option.withCheckBox){rowStr+="<td><input onclick='cgrid.grids[\""+tableid+"\"].ckCheck("+i+")' type='checkbox' class='ckb'></td>"}for(var j=0;j<colNames.length;++j){if(row[colNames[j]]||row[colNames[j]]===0){if(hideCols.indexOf(colNames[j])>=0){rowStr+="<td style='display: none;'"}else{rowStr+="<td style=''"}if(aCols.indexOf(colNames[j])>=0){rowStr+="><a href='#' class='tdLink' td-map='"+i+","+colNames[j]+"'>"+row[colNames[j]]+"</a></td>"}else{var cellVal=row[colNames[j]];if(gridobj.option.numfixed>-1&&!isNaN(parseFloat(cellVal))){var tempnum=Math.pow(10,gridobj.option.numfixed);if(this.option.colTitle){rowStr+=" title='"+cellVal+"'>"+parseFloat(cellVal).toFixed(gridobj.option.numfixed)*tempnum/tempnum+"</td>"}else{rowStr+=" title=''>"+parseFloat(cellVal).toFixed(gridobj.option.numfixed)*tempnum/tempnum+"</td>"}}else{if(this.option.colTitle){rowStr+=" title='"+cellVal+"'>"+cellVal+"</td>"}else{rowStr+=" title=''>"+cellVal+"</td>"}}}}else{rowStr+="<td style=''></td>"}}rowStr+="</tr>";rowsStr+=rowStr}rowsStr+="</tbody>";tableStr+=headStr+rowsStr+"</table>";var tableDiv=$("#"+tableid);tableDiv.empty().append(tableStr);var _this=this;$('#'+tableid+' .tdLink').click(function(e){e.stopPropagation();var map=$(e.target).attr('td-map');_this.colLinkClick(map.split(',')[0],map.split(',')[1],e)});if(this.mergeincols&&this.mergeincols.length>0){for(var i=0;i<this.mergeincols.length;++i){gridobj.rowspan(this.mergeincols[i])}}if(gridobj.option.mergeinrows&&gridobj.option.mergeinrows.length>0){for(var i=0;i<gridobj.option.mergeinrows.length;++i){gridobj.colspan(gridobj.option.mergeinrows[i],gridobj.option.mergerowcellsize)}}if(this.fixedCols&&this.fixedCols.length>0||this.option.titleFixed){$('#'+tableid+' table').css('border-collapse','separate');if(this.option.titleFixed){$('#'+tableid+' table th').css('position','relative')}this.scrollEvent();for(var i in this.fixedCols){var c=this.fixedCols[i];this.addTitleRel(c);this.addPositionRel(c)}for(var i in this.fixedHeads){var colName=this.fixedHeads[i];var theadObj=$("#"+tableid+" table tr th[data-field='"+colName+"']");theadObj.css('z-index',2);theadObj.css('position','relative')}}this.option.finished()};gridobj.rowspan=function(table_colnum){var table_firsttd="";var table_currenttd="";var table_SpanNum=0;var colnum_Obj=$('#'+tableid+" table tbody tr td:nth-child("+table_colnum+")");var mergesize=1;var _this=this;colnum_Obj.each(function(i){if(i===0){table_firsttd=$(this);table_SpanNum=1}else{table_currenttd=$(this);if(table_firsttd.text()!==""&&mergesize<_this.option.mergecolcellsize&&table_firsttd.text()===table_currenttd.text()){table_SpanNum++;table_currenttd.hide();table_firsttd.attr("rowSpan",table_SpanNum);++mergesize}else{table_firsttd=$(this);table_SpanNum=1;mergesize=1}}})};gridobj.colspan=function(table_rownum,table_maxcolnum){if(table_maxcolnum===void 0){table_maxcolnum=0}var table_firsttd="";var table_currenttd="";var table_SpanNum=0;$('#'+tableid+" table tbody tr:nth-child("+table_rownum+")").each(function(i){var row_Obj=$(this).children();row_Obj.each(function(i){if(i===0){table_firsttd=$(this);table_SpanNum=1}else if((table_maxcolnum>0)&&(i>table_maxcolnum)){return""}else{table_currenttd=$(this);if(table_firsttd.text()===table_currenttd.text()){table_SpanNum++;table_currenttd.hide();table_firsttd.attr("colSpan",table_SpanNum)}else{table_firsttd=$(this);table_SpanNum=1}}})})};gridobj.clickTimeId=null;gridobj.doubleClickRow=function(rownum){clearTimeout(this.clickTimeId);this.option.onRowDbClick(rownum)};gridobj.clickRow=function(rownum){clearTimeout(this.clickTimeId);var _this=this;this.clickTimeId=setTimeout(function(){_this.option.onRowClick(rownum)},200)};gridobj.getTitleMap=function(){var titleMap={};titleMap.titles=this.titles.toString();titleMap.titles_zh=this.titles_zh.toString();return titleMap};gridobj.oneClickRow=function(rownum){if(this.isCkChecked){this.isCkChecked=false}else{this.clickRow(rownum)}};gridobj.colLinkClick=function(rownum,colname,t){this.option.onLinkClick(rownum,colname,t)};gridobj.genPage=function(pagenum){if(this.option.hasPage){var startRow=(pagenum-1)*this.option.rowNum;var endRow=pagenum*this.option.rowNum;if(startRow>this.allPageData.length){console.log("该页没有数据");return}var pagedatas=[];for(var i=startRow;i<endRow&&i<this.allPageData.length;++i){pagedatas.push(this.allPageData[i])}this.genTable(pagedatas)}};gridobj.ckBox=function(){var cked=$('#'+tableid+' table thead input[type="checkbox"]').prop('checked');if(!cked){this.uncheckAll()}else{this.checkAll()}};gridobj.checkAll=function(){if(this.option.withCheckBox){$('#'+tableid+' table tbody input[type="checkbox"]').prop('checked',true)}};gridobj.uncheckAll=function(){if(this.option.withCheckBox){$('#'+tableid+' table tbody input[type="checkbox"]').prop('checked',false)}};gridobj.getChecked=function(){if(this.data.length<1){return[]}var list=[];var ck=$('#'+tableid+' table tbody input[type="checkbox"]');for(var i=0;i<ck.length;++i){if(ck[i].checked){list.push(this.data[i])}}return list};gridobj.isCkChecked=false;gridobj.ckCheck=function(rownum){if(!this.option.withCheckBox){return}this.isCkChecked=true;if(this.option.disableMutiSel){var ck=$('#'+tableid+' table tbody input[type="checkbox"]');for(var i=0;i<ck.length;++i){if(rownum!==i&&ck[i].checked){ck[i].checked=false}}}};gridobj.scrollAction={x:undefined,y:undefined};gridobj.scrollDirection=0;gridobj.addTitleRel=function(num){var thead=$("#"+tableid+" table tr th:nth-child("+num+")");thead.css('position','relative');thead.css('background-color','white')};gridobj.addPositionRel=function(num){var trow=$("#"+tableid+" table tr td:nth-child("+num+")");trow.css('position','relative');trow.css('background-color','white');trow.css('z-index',1)};gridobj.setFixedCol=function(num,x){var trow=$("#"+tableid+" table tr td:nth-child("+num+")");trow.css('left',x)};gridobj.setFixedHead=function(colName,x){var thead=$("#"+tableid+" table tr th[data-field='"+colName+"']");thead.css('left',x)};gridobj.setFixedTitle=function(y){$("#"+tableid+" table th").css('top',y)};gridobj.scrollEvent=function(){var _this=this;$('#'+tableid).scroll(function(e){_this.scrollFunc();if(_this.scrollDirection>0&&_this.option.titleFixed){_this.setFixedTitle(_this.scrollAction.y)}else if(_this.scrollDirection<0){for(var i in _this.fixedCols){var item=_this.fixedCols[i];_this.setFixedCol(item,_this.scrollAction.x)}for(var i in _this.fixedHeads){var item=_this.fixedHeads[i];_this.setFixedHead(item,_this.scrollAction.x)}}})};gridobj.scrollFunc=function(){var tableDiv=$('#'+tableid);if(typeof this.scrollAction.x===undefined){this.scrollAction.x=tableDiv.scrollLeft();this.scrollAction.y=tableDiv.scrollTop()}var diffX=this.scrollAction.x-tableDiv.scrollLeft();var diffY=this.scrollAction.y-tableDiv.scrollTop();if(diffX<0){this.scrollDirection=-2}else if(diffX>0){this.scrollDirection=-1}else if(diffY<0){this.scrollDirection=1}else if(diffY>0){this.scrollDirection=2}else{this.scrollDirection=0}this.scrollAction.x=tableDiv.scrollLeft();this.scrollAction.y=tableDiv.scrollTop()};cgrid.grids[tableid]=gridobj;return gridobj}};